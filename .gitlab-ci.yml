stages:
  - build
  - test

build_data_export:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - cd data-export
    - docker build -t data-export:latest .
  only:
    - main
    - develop

build_dbt:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - cd dbt-project
    - docker build -t dbt:latest .
  only:
    - main
    - develop

test_parse:
  stage: test
  image: ghcr.io/dbt-labs/dbt-postgres:1.9.0
  variables:
    POSTGRES_HOST: localhost
    POSTGRES_PORT: "5432"
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    POSTGRES_DB: test
  script:
    - cd dbt-project
    - dbt parse
  only:
    - main
    - develop

test_compile:
  stage: test
  image: ghcr.io/dbt-labs/dbt-postgres:1.9.0
  variables:
    POSTGRES_HOST: localhost
    POSTGRES_PORT: "5432"
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    POSTGRES_DB: test
  script:
    - cd dbt-project
    - dbt compile --target test
  allow_failure: true
  artifacts:
    paths:
      - dbt-project/target/
    expire_in: 7 days
  only:
    - main
    - develop

generate_docs:
  stage: test
  image: ghcr.io/dbt-labs/dbt-postgres:1.9.0
  variables:
    POSTGRES_HOST: localhost
    POSTGRES_PORT: "5432"
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    POSTGRES_DB: test
  script:
    - cd dbt-project
    - dbt docs generate --target test
  allow_failure: true
  artifacts:
    paths:
      - dbt-project/target/
    expire_in: 30 days
  only:
    - main
    - develop
